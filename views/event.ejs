<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Kickabout | Pay</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
  <link rel="stylesheet" href="css/input.css">
  <link rel="icon" href="img/favicon.png">
  <link href="css/coded.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Muli' rel='stylesheet' type='text/css'>
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
</head>
<body>
  <script type="text/javascript">

    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function validatePhoneNumber(phoneNumber) {
      phoneNumber = phoneNumber.replace(/\D/gm, '');
      if(phoneNumber.substring(0, 2) === "44"){
        if(phoneNumber.length === 12){
          return phoneNumber.substring(2)
        }
        else {
          return -1;
        }
      }
      else if(phoneNumber.substring(0, 4) === "0044"){
        if(phoneNumber.length === 14){
          return phoneNumber.substring(4)
        }
        else {
          return -1;
        }
      }
      else if(phoneNumber.substring(0, 1) === "0"){
        if(phoneNumber.length === 11){
          return phoneNumber.substring(1)
        }
        else {
          return -1;
        }
      }
      else if(phoneNumber.length == 10){
        return phoneNumber
      }
      else {
        return -1;
      }
    }

    function submitData() {
      alert(1)
      var phoneNumber = validatePhoneNumber($('#phoneNumber').val());
      if (phoneNumber === -1) {
        alert(2)
        $('#warning').fadeIn(200);
      } else {
        alert(3)
        localStorage.setItem('phoneNumber', phoneNumber);
        location.href = "<%=config.ROOT_URL%>/payment?eid=<%=eid%>&pn="
         + phoneNumber;
         alert(4)
        /*
        if (<%= event.price %> === 0) {
          location.href = "<%=config.ROOT_URL%>/charge?&eventPrice=" 
           + "<%=event.price*100%>&eid=<%=eid%>&pn=" + phoneNumber;
        } else {
          location.href = "<%=config.ROOT_URL%>/payment?eid=<%= eid %>"
           + "&eventPrice=<%= event.price %>&pn=" + phoneNumber;
        }
        */
      }
    }

    $(document).ready(() => {
      if (localStorage.getItem('phoneNumber')) {
        $('#phoneNumber').val('+44' + localStorage.getItem('phoneNumber'));
      }
      
      /*var phoneNumber = getParameterByName('pn');
      // if user is coming from bot (existing user)
      if (phoneNumber) {
        if (<%= event.price %> === 0) { // if free event
          console.log("free event");
          $.post("<%=config.ROOT_URL%>/charge" + "?&eventprice="
           + "<%= event.price*100 %>&eid=<%=eid%>&pn=" + phoneNumber, (data) => {
            console.log(data);
          })
        } else { //if paid event, redirect to payment
          location.href = "<%=config.ROOT_URL%>/payment?eid=<%= eid %>&gp="
           + "<% event.price %>&pn=" + phoneNumber;
        }
      }*/

      //if user not coming from bot, could be existing
      $('#pnform').submit((e) => {
        console.log(1)
        e.preventDefault();
        console.log(2)
        var phoneNumber = validatePhoneNumber($('#phoneNumber').val());
        if (phoneNumber === -1) {
          console.log(3)
          $('#warning').fadeIn(200);
        } else {
          console.log(4)
          localStorage.setItem('phoneNumber', phoneNumber);

          location.href = "<%=config.ROOT_URL%>/charge?eid=<%=eid%>&pn="
           + phoneNumber;
           console.log(5)
          /*
          if (<%= event.price %> === 0) {
            location.href = "<%=config.ROOT_URL%>/charge?&eventPrice=" 
             + "<%=event.price*100%>&eid=<%=eid%>&pn=" + phoneNumber;
          } else {
            location.href = "<%=config.ROOT_URL%>/payment?eid=<%= eid %>"
             + "&eventPrice=<%= event.price %>&pn=" + phoneNumber;
          }
          */
        }
      });
    });
  </script>

  <div class="site-wrapper-payment">

    <div class="site-wrapper-inner2">

      <img src="img/logoUnbinded-white.png" class="logoLead-payment">
      <br/>
      <!-- event image -->
      <img src="<%= event.image_url %>" style="width: 200px">
      <p class="eventtitle" style="font-size:14px;"><%= event.name %></p>
      <p class="eventaddress" style="font-size:14px;"><%= event.address %></p>
      <p><%= event.description %></p>

      <!-- shown when user enters invalid phone number -->
      <h3 id="warning" style="display:none; font-size:14px; color:#FF3300">
        Invalid phone number.
      </h3>

      <div class="formContainer">
        <!-- <form class="form-horizontal" id="pnform" action="/charge" method="POST"> -->
        <div class="input-group centre-group">
          <div class="input-group-addon custom-width">Phone Number</div>
          <input name="phone" autocomplete="tel" 
           placeholder="Eg: 07231324112" id="phoneNumber" type="text" 
           class="form-control" required>
        </div>
        <br/>
        <div class="form-group">
          <button type="button" value="Submit" onclick="submitData()" class="btn btn-primary">Submit</button>
        </div>
        <!-- </form> -->
      </div>

      <div class="footerDiv">
        <p class="footertext">
          Activate Technologies Ltd, Gordon House, 29 Gordon Square, London,
          WC1H 0PP
          <br>
          www.activatetechnologies.co.uk
        </p>
      </div>

    </div>

  </div>

</body>
</html>
