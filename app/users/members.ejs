<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
	</head>

	<body ng-app="sortTable" ng-controller="usersCtrl">
		<div class="container">
			<h1>Users</h1>
			<!-- <input ng-model="filterBy"> -->
			<ul>
				<li ng-repeat="user in selectedItems">{{user.firstName + " " + user.lastName}}</li>
			</ul>
			<div class="table-responsive">
	            <table class="table table-striped">
	              <thead>
	                <tr>
	                  <th></th>
	                  <th>FB Profile Pic</th>
	                  <th ng-click="headingClicked(0)">Name <span class="glyphicon glyphicon-sort-by-attributes" ng-if="currentHead==0 && isReversed==false"></span><span class="glyphicon glyphicon-sort-by-attributes-alt" ng-if="currentHead==0 && isReversed==true"></span></th>
	                  <th ng-click="headingClicked(1)">Gender <span class="glyphicon glyphicon-sort-by-attributes" ng-if="currentHead==1 && isReversed==false"></span><span class="glyphicon glyphicon-sort-by-attributes-alt" ng-if="currentHead==1 && isReversed==true"></span></th>
	                  <th ng-click="headingClicked(2)" ng-if="isDisplayed(2)">Phone Number <span class="glyphicon glyphicon-sort-by-attributes" ng-if="currentHead==2 && isReversed==false"></span><span class="glyphicon glyphicon-sort-by-attributes-alt" ng-if="currentHead==2 && isReversed==true"></span></th>
                    <th ng-if="isDisplayed(3)">Email</th>
                    <th ng-if="isDisplayed(4)" ng-click="headingClicked(4)">Preferred Position <span class="glyphicon glyphicon-sort-by-attributes" ng-if="currentHead==4 && isReversed==false"></span><span class="glyphicon glyphicon-sort-by-attributes-alt" ng-if="currentHead==4 && isReversed==true"></span></th>
                    <th ng-if="isDisplayed(5)" ng-click="headingClicked(5)">Backup Position <span class="glyphicon glyphicon-sort-by-attributes" ng-if="currentHead==5 && isReversed==false"></span><span class="glyphicon glyphicon-sort-by-attributes-alt" ng-if="currentHead==5 && isReversed==true"></span></th>
                    <th ng-if="isDisplayed(6)" ng-click="headingClicked(6)">Level <span class="glyphicon glyphicon-sort-by-attributes" ng-if="currentHead==6 && isReversed==false"></span><span class="glyphicon glyphicon-sort-by-attributes-alt" ng-if="currentHead==6 && isReversed==true"></span></th>
                    <th ng-if="isDisplayed(7)" ng-click="headingClicked(7)">New/Returning <span class="glyphicon glyphicon-sort-by-attributes" ng-if="currentHead==7 && isReversed==false"></span><span class="glyphicon glyphicon-sort-by-attributes-alt" ng-if="currentHead==7 && isReversed==true"></span></th>
                    <th ng-click="headingClicked(8)">Signed Up Date <span class="glyphicon glyphicon-sort-by-attributes" ng-if="currentHead==8 && isReversed==false"></span><span class="glyphicon glyphicon-sort-by-attributes-alt" ng-if="currentHead==8 && isReversed==true"></span></th>
                    <th>Messenger ID</th>
<!-- 	                  <th ng-click="headingClicked(3)"><span class="glyphicon glyphicon-sort-by-attributes" ng-if="currentHead==3 && isReversed==false"> </span><span class="glyphicon glyphicon-sort-by-attributes-alt" ng-if="currentHead==3 && isReversed==true"> </span>No Of Events Attended</th> -->
	                  <th>Select</th>
	                </tr>
	              </thead>
	              <tbody id="usersTBody">
	              	<tr ng-repeat="user in users | orderBy:orderField:isReversed | filter:filterBy">
	              		<td>{{$index + 1}}</td>
	              		<td><img style="height:50px;" src="{{user.profilePic}}" /></td>
	              		<td>{{user.firstName + " " + user.lastName}}</td>
	              		<td>{{user.gender}}</td>
	              		<td ng-if="isDisplayed(2)">{{user.phoneNumber}}</td>
                    <td ng-if="isDisplayed(3)">{{user.email}}</td>
                    <td ng-if="isDisplayed(4)">{{user.preferredPosition}}</td>
                    <td ng-if="isDisplayed(5)">{{user.backupPosition}}</td>
                    <td ng-if="isDisplayed(6)">{{user.level}}</td>
                    <td ng-if="isDisplayed(7)">{{user.type}}</td>
	              		<td>{{user.signedUpDate}}</td>
                    <td>{{user.mid}}</td>
	              		<td><input type="checkbox" ng-model="selection" ng-change="updateSelectedItems(user._id)"></td>
	              	</tr>
	              </tbody>
	            </table>
        	</div>
		</div>

    <script type="text/javascript">
    var app = angular.module('sortTable' , []);

    app.controller('usersCtrl', ['$scope', '$http' , function($scope, $http) {
      $http.get('/userAnalyticsData.<%= s.company.code %>').success(function(response) {
        $scope.users = response.users;
        var hashtable = {
          "phoneNumber": 1,
          "email":2
        }
        hashtable[user.extras]
      })

      $scope.currentHead = -1;

      $scope.isDisplayed = function(head) {
        console.log("HELLO", head);
        for(i = 0; i < $scope.users.length; i++) {
          switch(head) {
            case 2:
              if($scope.users[i].phoneNumber != null) {
                return true;
              }
              break;
            case 3:
              if($scope.users[i].email != null) {
                return true;
              }
              break;
            case 4:
              if($scope.users[i].preferredPosition != null) {
                return true;
              }
              break;
            case 5:
              if($scope.users[i].backupPosition != null) {
                return true;
              }
              break;
            case 6:
              if($scope.users[i].level != null) {
                return true;
              }
              break;
            case 7:
              if($scope.users[i].type != null) {
                return true;
              }
              break;
          }
        }
        return false;
      }

      $scope.headingClicked = function(head) {
        if($scope.currentHead == head) {
          $scope.isReversed = !$scope.isReversed;
        } else {
          $scope.isReversed = false;
        }

        $scope.currentHead = head;

        switch(head) {
          case 0:
            $scope.orderField = ['firstName','lastName'];
            break;
          case 1:
            $scope.orderField = 'gender';
            break;
          case 4:
            $scope.orderField = 'preferredPosition';
            break;
          case 5:
            $scope.orderField = 'backupPosition';
            break;
          case 6:
            $scope.orderField = 'level';
            break;
          case 7:
            $scope.orderField = 'type';
            break;
          case 8:
            $scope.orderField = 'signedUpDate';
            break;
        }
      }

      $scope.selectedItems = [];

      $scope.updateSelectedItems = function(id) {
        console.log(id);
        var index = JSON.stringify($scope.selectedItems).indexOf(id);
        if(index < 0) {
          $scope.users.forEach(function(user) {
            if (user._id == id) {
              $scope.selectedItems.push(user);
            }
          });
        } else {
          for(i = 0; i < $scope.selectedItems.length; i++) {
            if($scope.selectedItems[i]._id == id) {
              $scope.selectedItems.splice(i, 1);
              console.log("BYE");
            }
          }
        }
        console.log($scope.selectedItems);
      }
    }])

    </script>
	</body>
</html>
